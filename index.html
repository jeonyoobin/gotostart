<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Focus Task - Windows</title>
    <style>
        :root {
            --bg-color: #f5f5f7; 
            --text-main: #3d444b; 
            --point-blue: #7fb3d5; 
            --line-color: #555555; 
            --nm-out: 6px 6px 14px #d1d1d6, -6px -6px 14px #ffffff;
            --nm-in: inset 3px 3px 7px #d1d1d6, inset -2px -2px 7px #ffffff;
            --nm-btn: 3px 3px 8px #d1d1d6, -2px -2px 6px #ffffff;
            --nm-btn-hover: 4px 4px 10px #c8c8cf, -3px -3px 8px #ffffff;
        }

        /* 윈도우 창 스타일 (15x3 비율 느낌의 400x500 설정) */
        * { scrollbar-gutter: stable; box-sizing: border-box; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; border: 2px solid var(--bg-color); }

        body { 
            background: var(--bg-color); color: var(--text-main); 
            font-family: 'Inter', 'Pretendard', sans-serif; 
            margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden;
            -webkit-user-select: none; user-select: none;
        }

        /* 창 드래그 영역 (Electron 등에서 활용 가능) */
        .title-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 30px;
            -webkit-app-region: drag; /* 데스크톱 앱 전환 시 드래그 가능 구역 */
            z-index: 10000;
        }

        #project-viewport { 
            display: flex; width: 100%; height: 100vh; 
            transition: transform 0s; align-items: flex-start; 
        }
        #project-viewport.ready { transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }

        .project-card { 
            min-width: 100%; height: 100vh; 
            overflow-y: hidden; display: flex; flex-direction: column; align-items: center; 
        }
        #project-viewport.ready .project-card { overflow-y: auto; }

        /* 네비게이션 바 */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; pointer-events: none; z-index: 9999; display: flex; justify-content: center; align-items: center; background: linear-gradient(to top, var(--bg-color) 60%, transparent); }
        .nav-btn { position: absolute; bottom: 25px; width: 36px; height: 36px; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-btn); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #555; opacity: 0; transition: 0.2s; pointer-events: auto; }
        .nav-left { left: 20px; } .nav-right { right: 20px; }
        .page-indicator { position: absolute; bottom: 35px; display: flex; flex-direction: column; align-items: center; opacity: 0; transition: 0.2s; pointer-events: none; }
        .page-text { font-size: 11px; font-weight: 700; color: #777; letter-spacing: 1px; margin-bottom: 4px; }

        .trash-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto; }
        .trash-icon { width: 10px; height: 12px; border: 1.5px solid #888; border-bottom-left-radius: 2px; border-bottom-right-radius: 2px; position: relative; }
        .trash-icon::before { content: ''; position: absolute; top: -3.5px; left: -3px; width: 16px; height: 1.5px; background: #888; border-radius: 1px; }

        /* 상단 메뉴 (X버튼, 일시정지) */
        .top-menu { position: fixed; top: 15px; right: 20px; display: flex; gap: 12px; z-index: 9900; -webkit-app-region: no-drag; } 
        .menu-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-btn); display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; transition: 0.2s; font-size: 14px; font-weight: bold; }
        .stop-icon { width: 8px; height: 8px; background: #333; border-radius: 1px; }

        /* 태스크 리스트 스타일 */
        .task-container { display: flex; flex-direction: column; align-items: center; width: 100%; min-height: 100%; box-sizing: border-box; } 
        .scroll-spacer { height: 140px; width: 100%; flex-shrink: 0; }
        .task-list { display: flex; flex-direction: column-reverse; align-items: center; width: 100%; }
        .task-wrapper { display: flex; flex-direction: column; align-items: center; width: 100%; transition: 0.3s ease; }
        .task-wrapper.completed { display: none !important; }
        .task-wrapper.is-hidden { display: none !important; } 
        .task-wrapper.is-waiting { opacity: 0.2; pointer-events: none; }

        .input-group { position: relative; display: flex; align-items: center; width: 100%; justify-content: center; }
        .input-container { 
            position: relative; display: flex; align-items: center; 
            background: var(--bg-color); border-radius: 14px; box-shadow: var(--nm-out); 
            width: 180px; padding: 0 35px; transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); 
            justify-content: center; z-index: 1; 
        }

        .task-input { background: transparent; border: none; padding: 12px 0; font-size: 12px; font-weight: 600; color: var(--text-main); width: 100%; text-align: center; outline: none; }
        
        .btn-icon { position: absolute; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; background: var(--bg-color); box-shadow: var(--nm-btn); transition: 0.2s; z-index: 5; }
        .start-trigger { left: 8px; opacity: 0; }
        .delete-trigger { right: 8px; color: #ff6b6b; font-size: 11px; opacity: 0; pointer-events: none; }

        .input-group:hover .start-trigger { opacity: 0.8; }
        .task-wrapper:not(.main-task) .input-group:hover .delete-trigger { opacity: 0.8; pointer-events: auto; }

        .inner-toggle { position: absolute; right: 8px; width: 0; opacity: 0; transition: 0.4s; display: flex; align-items: center; z-index: 10; }
        .is-hero .inner-toggle { width: 36px; opacity: 1; }
        
        .toggle-frame { width: 34px; height: 18px; background: #e0e0e0; border-radius: 10px; display: flex; align-items: center; cursor: pointer; position: relative; }
        .toggle-circle { width: 12px; height: 12px; background: #fff; border-radius: 50%; position: absolute; left: 3px; transition: 0.2s; }
        .toggle-frame.active { background: var(--point-blue); }
        .toggle-frame.active .toggle-circle { left: 19px; }

        .is-hero .input-container { width: 220px; transform: scale(1.05); background: #ffffff; }
        .is-hero .start-trigger { opacity: 1 !important; color: #5dade2; }

        .bridge-zone { height: 35px; width: 100%; position: relative; display: flex; align-items: center; justify-content: center; }
        .bridge-line { width: 1.5px; height: 12px; background: var(--line-color); opacity: 0.15; }
        .bridge-add-btn { position: absolute; width: 20px; height: 20px; background: var(--bg-color); border-radius: 50%; color: var(--point-blue); box-shadow: var(--nm-btn); cursor: pointer; z-index: 5; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 800; opacity: 0; }
        .bridge-zone:hover .bridge-add-btn { opacity: 1 !important; }

        .play-icon { width: 0; height: 0; border-top: 4.5px solid transparent; border-bottom: 4.5px solid transparent; border-left: 6.5px solid #333; margin-left: 2px; }
        .pause-icon { display: flex; gap: 3.5px; } .pause-icon div { width: 2.5px; height: 10px; background: #333; }

        /* 피니시 & 엔딩 */
        #finish-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-color); z-index: 8000; }
        .select-main { width: 190px; padding: 12px 18px; background: var(--bg-color); border-radius: 14px; box-shadow: var(--nm-btn); display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 12px; font-weight: 700; }
        .dropdown-container { position: relative; width: 190px; }
        .select-options { position: absolute; top: 55px; left: 0; width: 100%; background: var(--bg-color); border-radius: 14px; box-shadow: var(--nm-out); display: none; flex-direction: column; z-index: 8001; padding: 5px 0; }
        .dropdown-container.open .select-options { display: flex; }
        .option-item { padding: 12px 18px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .option-item:hover { background: #e8e8ea; color: var(--point-blue); }

        #ending-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: none; z-index: 9800; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(180deg, #dbeafe 0%, #f5f5f7 100%); }
        .plane-icon { width: 60px; height: 60px; fill: #444; opacity: 0.7; animation: plane-fly 4s ease-in-out infinite; }
        @keyframes plane-fly { 0%, 100% { transform: translate(0, 0) rotate(5deg); } 50% { transform: translate(15px, -20px) rotate(-5deg); } }

        body.empty-state #project-viewport, body.empty-state .nav-bar, body.empty-state #finish-screen { display: none !important; }
        body.single-project .trash-btn { display: none !important; }
    </style>
</head>
<body id="main-body" onmousemove="showNav(event)">

    <div class="title-bar"></div>

    <div id="ending-overlay">
        <svg class="plane-icon" viewBox="0 0 24 24"><path d="M21 3L3 10.53V11.5L9.84 13.67L12 20.33L13 21L21 3M19.34 5.34L11.5 13.18L10.32 9.68L19.34 5.34M13.18 11.5L14.32 18.68L18.66 9.66L13.18 11.5Z"/></svg>
    </div>

    <div class="top-menu">
        <div class="menu-btn" onclick="playSnd('H'); handleMainBtn();"><div class="stop-icon"></div></div>
        <div class="menu-btn" onclick="playSnd('H'); exitApp();">✕</div>
    </div>

    <div class="nav-bar">
        <div class="nav-btn nav-left" id="btn-left" onclick="playSnd('H'); moveCard(-1)">❮</div>
        <div class="page-indicator" id="indicator">
            <div class="page-text" id="page-num">1 / 1</div>
            <div class="trash-btn" onclick="playSnd('H'); deleteCurrentProject();"><div class="trash-icon"></div></div>
        </div>
        <div class="nav-btn nav-right" id="btn-right" onclick="playSnd('H'); moveCard(1)">❯</div>
    </div>

    <div id="project-viewport"></div>

    <div id="finish-screen">
        <div class="dropdown-container" id="dropdown">
            <div class="select-main" onclick="playSnd('G'); toggleDropdown();"><span>선택</span><div style="width: 7px; height: 7px; border-right: 2px solid #555; border-bottom: 2px solid #555; transform: rotate(45deg);"></div></div>
            <div class="select-options">
                <div class="option-item" onclick="handleFinishAction();">짐 내려놓기</div>
                <div class="option-item" onclick="resetApp();">새로운 시작</div>
            </div>
        </div>
    </div>

    <script>
        let projects = [{ tasks: [{ val: "너를 짓누르는 그 일을 적어봐", isMain: true }] }];
        let currentIdx = 0;
        const STORAGE_KEY = 'focus_task_data';

        // 사운드 함수 (로컬 파일용)
        function playSnd(name) {
            const audio = new Audio(`./sounds/${name}.wav`);
            audio.play().catch(e => console.log("Sound play blocked"));
        }

        // 초기 데이터 로드
        window.onload = function() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                projects = parsed.projects;
                currentIdx = parsed.currentIdx || 0;
            }
            renderAllCards();
            updateViewport();
        };

        function saveData() {
            // 현재 입력값들 업데이트
            const cards = document.querySelectorAll('.project-card');
            cards.forEach((card, idx) => {
                if (projects[idx]) {
                    const tasks = [];
                    const wrappers = card.querySelectorAll('.task-wrapper:not(.completed)');
                    wrappers.forEach(w => {
                        tasks.push({ val: w.querySelector('.task-input').value, isMain: w.classList.contains('main-task') });
                    });
                    projects[idx].tasks = tasks;
                }
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ projects, currentIdx }));
        }

        function renderAllCards() {
            const viewport = document.getElementById('project-viewport');
            viewport.innerHTML = '';
            projects.forEach((proj) => {
                const card = document.createElement('div');
                card.className = 'project-card';
                card.innerHTML = `
                    <div class="task-container">
                        <div class="scroll-spacer"></div>
                        <div class="task-list"></div>
                        <div class="scroll-spacer" style="height: 100px;"></div>
                    </div>`;
                const list = card.querySelector('.task-list');
                proj.tasks.forEach(t => list.appendChild(createTaskElement(t.val, t.isMain)));
                viewport.appendChild(card);
            });
        }

        function updateViewport() {
            const vp = document.getElementById('project-viewport');
            vp.classList.remove('ready');
            vp.style.transform = `translateX(-${currentIdx * 100}%)`;
            document.getElementById('page-num').innerText = `${currentIdx + 1} / ${projects.length}`;
            document.body.classList.toggle('single-project', projects.length <= 1);
            setTimeout(() => vp.classList.add('ready'), 500);
        }

        function createTaskElement(val, isMain) {
            const wrapper = document.createElement('div');
            wrapper.className = `task-wrapper ${isMain ? 'main-task' : ''}`;
            wrapper.innerHTML = `
                <div class="bridge-zone"><div class="bridge-line"></div><div class="bridge-add-btn" onclick="addTask(this)">+</div></div>
                <div class="input-group">
                    <div class="input-container">
                        <div class="btn-icon start-trigger" onclick="toggleHero(this)"><div class="play-icon"></div></div>
                        <input type="text" class="task-input" value="${val}" onfocus="if(this.value.includes('?'))this.value=''" onblur="saveData()">
                        <div class="inner-toggle"><div class="toggle-frame" onclick="handleToggle(this)"><div class="toggle-circle"></div></div></div>
                        <div class="btn-icon delete-trigger" onclick="deleteTask(this)">✕</div>
                    </div>
                </div>`;
            return wrapper;
        }

        function moveCard(dir) {
            if (document.body.classList.contains('has-hero')) return;
            currentIdx += dir;
            if (currentIdx < 0) currentIdx = 0;
            if (currentIdx >= projects.length) {
                projects.push({ tasks: [{ val: "너를 짓누르는 그 일을 적어봐", isMain: true }] });
                renderAllCards();
            }
            updateViewport();
            saveData();
        }

        function handleToggle(el) {
            if (el.classList.contains('active')) return;
            playSnd('D'); 
            el.classList.add('active');
            const wrapper = el.closest('.task-wrapper');
            
            setTimeout(() => {
                wrapper.classList.add('completed');
                const card = wrapper.closest('.project-card');
                const remaining = Array.from(card.querySelectorAll('.task-wrapper:not(.completed):not(.is-hidden)'));
                const next = remaining[remaining.length - 1];
                
                if (next) {
                    next.classList.remove('is-waiting');
                    next.classList.add('is-hero');
                    next.querySelector('.start-trigger').innerHTML = '<div class="pause-icon"><div></div><div></div></div>';
                    updateStates();
                } else {
                    playSnd('F');
                    document.getElementById('finish-screen').style.display = 'flex';
                }
                saveData();
            }, 300);
        }

        function toggleHero(btn) {
            const wrapper = btn.closest('.task-wrapper');
            if (!wrapper.classList.contains('is-hero')) {
                playSnd('B'); document.body.classList.add('has-hero');
                wrapper.classList.add('is-hero');
                btn.innerHTML = '<div class="pause-icon"><div></div><div></div></div>';
                updateStates();
            } else {
                playSnd('E'); document.body.classList.remove('has-hero');
                wrapper.classList.remove('is-hero');
                btn.innerHTML = '<div class="play-icon"></div>';
                document.querySelectorAll('.task-wrapper').forEach(t => t.classList.remove('is-waiting', 'is-hidden'));
            }
        }

        function updateStates() {
            const currentCard = document.querySelectorAll('.project-card')[currentIdx];
            const all = Array.from(currentCard.querySelectorAll('.task-wrapper:not(.completed)'));
            const hero = currentCard.querySelector('.is-hero');
            if(!hero) return;
            const idx = all.indexOf(hero);
            all.forEach((el, i) => {
                if(i > idx) el.classList.add('is-hidden');
                else if(i < idx) el.classList.add('is-waiting');
            });
        }

        function addTask(btn) {
            playSnd('A');
            const wrapper = btn.closest('.task-wrapper');
            const list = wrapper.closest('.task-list');
            const newTask = createTaskElement("이 사이에 들어갈 일은?", false);
            list.insertBefore(newTask, wrapper.nextSibling);
            saveData();
        }

        function deleteTask(btn) { btn.closest('.task-wrapper').remove(); saveData(); }

        function showNav(e) {
            const isBottom = e.clientY > window.innerHeight - 80;
            const op = isBottom ? "1" : "0";
            document.getElementById('btn-left').style.opacity = op;
            document.getElementById('btn-right').style.opacity = op;
            document.getElementById('indicator').style.opacity = op;
        }

        function handleMainBtn() { location.reload(); }
        function exitApp() { window.close(); } // 윈도우 창 닫기
        function toggleDropdown() { document.getElementById('dropdown').classList.toggle('open'); }
        function handleFinishAction() {
            if (projects.length > 1) {
                projects.splice(currentIdx, 1);
                currentIdx = 0;
                saveData();
                location.reload();
            } else {
                document.getElementById('finish-screen').style.display = 'none';
                document.getElementById('ending-overlay').style.display = 'flex';
                setTimeout(() => { localStorage.clear(); location.reload(); }, 3000);
            }
        }
        function resetApp() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
